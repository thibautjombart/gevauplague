---
title: "How did it start?"
author: "Thibaut Jombart, Henry Mouysset"
date: "2024-03-22"
output:
  html_document: default
  pdf_document: default
bibliography: biblio.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  include = TRUE,
  fig.width = 7, 
  out.width = "80%",
  warning = FALSE, 
  message = FALSE
  )
```

# Preamble

In this report, we investigate some of the key elements of the early stages of the Plague epidemic in Gévaudan, which started in 1720 in the village of Correjac, soon followed by the town of La Canourgue. 

The analyses will rely on estimates of various epidemiological parameters, such as the case fatality ratio (CFR), the basic reproduction number ($R_0$), or delay distributions including the incubation period, the infectious period, or the serial interval. Where possible, these quantities are directly estimated from available date. Failing that, we use estimates from the literature.


# Estimates of key epidemiological features

## Delay distributions

### Incubation period

The incubation period has been characterised for Pneumonic plague as a lognormal distribution with mean 4.3 and standard deviation 1.8 [@Gani2004-hc]. Here we recreate this distribution using `distcrete`:

```{r}
library(distcrete)
library(tidyverse)

incub_pneumo <- distcrete(
  "lnorm", 
  meanlog = log(4.3), 
  sdlog = log(1.8), 
  interval = 1, 
  w = 0
  )

incub_dat <- tibble(
  Day = 0:20,
  p = incub_pneumo$d(0:20)
  )

incub_dat %>% 
  ggplot(aes(x = Day, y = p)) +
  geom_col(fill = 4) +
  theme_bw() +
  labs(
    x = "Time from infection to symptom onset (days)", 
    y = "Probability", 
    title = "Incubation time distribution - pneumonic plague", 
    subtitle = "(discretized lognormal)")

```


### Infectious period

The infectious period has been characterised for Pneumonic plague as a lognormal distribution with mean 2.5 and standard deviation reported as 1.2 [@Gani2004-hc]. This is likely an error though, as the graph presented in that paper is more compatible with an SD of 1.4, which we use here. Note that because this form had near 100% CFR, this is also the distribution of the time from onset of symptoms to death. 

```{r}

infec_pneumo <- distcrete(
  "lnorm", 
  meanlog = log(2.5), 
  sdlog = log(1.4), 
  interval = 1, 
  w = 0
  )


infec_dat <- tibble(
  Day = 0:7,
  p = infec_pneumo$d(0:7)
  )

infec_dat %>% 
  ggplot(aes(x = Day, y = p)) +
  geom_col(fill = 2) +
  theme_bw() +
  labs(
    x = "Time from symptom onset to death (days)", 
    y = "Probability", 
    title = "Infectious period distribution - pneumonic plague", 
    subtitle = "(discretized lognormal)")

```



# Patient zero: the convict from Marseille

The theory of the convict walking all the way from Marseille with an infected bundle of wool to eventually infect Jean Quintin in Saint Laurent d’Olt is suspicious: the man would have had to not get infected during his entire trip, to then infect JQ after a fairly brief encounter. 

The trip by foot via current roads is 273 km, and would have likely been longer using roads at the time. Especially since patrols were restricting movement in the area, and would have demanded some extra time to be avoided. 

We will explore 3 scenarios, with varying durations for the trip, which we posit was at least about 300 km: 

- 7 days (very optimistic, > 40 km per day)
- 12 days (~ 25km per day)
- 20 days (~ 15 km per day)

We do not know what the daily rate of infection $\lambda$ from the wool bundle, but we can derive a likelihood profile for each scenario, using:

$$
\mathcal{L(\lambda)} = p(T | \lambda) = (e^{-\lambda})^T (1 - e^{-\lambda})
$$

where $T$ is the number of days the trip took, and $(1 - e^{-\lambda})$ is the daily probability of infection from the infected bundle. 

Let us look at these profiles, ensuring we re-standardise both densities to 1 to make them comparable, as they rely on datasets of different sizes:

```{r}
like_trip <- function(lambda, T) {
  p <- 1 - exp(-lambda)
  (1 - p)^T * p
}

lambda_res <- tibble(
  val = seq(0, 1.2, length = 1000),
  "7 days" = like_trip(val, 7), 
  "12 days" = like_trip(val, 12), 
  "20 days" = like_trip(val, 20)
) %>% 
  mutate_at(
    vars(contains("days")), 
    function(x) x / sum(x)
  )

lambda_res_long <-  lambda_res %>% 
  pivot_longer(-1, names_to = "scenario", values_to = "likelihood") %>% 
  mutate(scenario = factor(scenario, levels = paste(c(7, 12, 20), "days")))
  
lambda_res_mle <- lambda_res_long %>% 
  group_by(scenario) %>% 
  summarise(MLE = val[which.max(likelihood)])

lambda_res_long %>% 
  ggplot(aes(x = val, y = likelihood, color = scenario)) +
  geom_line(linewidth = 2, alpha = 0.7) + 
  geom_vline(data = lambda_res_mle, aes(xintercept = MLE, color = scenario)) +
  theme_bw() + 
  labs(
    x = "Daily rate of infection (\U03BB)",
    y = "Likelihood",
    title = "Estimation of the probability of daily infection"
  ) +
  scale_x_continuous(n.breaks = 20)

lambda_res_mle

```

We find some more likely values than others, and this leans towards fairly low rates ranging from `r round(min(lambda_res_mle$MLE), 5)` to `r round(min(lambda_res_mle$MLE), 5)`. We calculate the corresponding probabilities that these events occurred using the MLE:

```{r}

lambda_res_mle <- lambda_res_mle %>% 
  mutate(
    days = as.integer(sub(" days", "", scenario)), 
    proba = like_trip(lambda = MLE, T = days)
    )
lambda_res_mle

```
The resulting probabilities are quite low, ranging from 
`r round(100*lambda_res_mle$proba[3], 1)`% chances for a trip of 20 days, to  
`r round(100*lambda_res_mle$proba[1], 1)`% for 7 days. To assess the overall plausibility of these scenari, questions remain: how many such trips where made by people carrying the infection from Marseille at the time? And were such trips indeed possible in the first place, given the containment measures in place?


# The first case after Jean

It is written that Jean showed symptoms on the 23rd November, and died 3 days later on the 26th. The first case in his household died on the 18th December. We can assess how likely this delay is by looking at the delay distributions for Pneumonic plague, integrating over the possible dates of infection (24th, 25th, 26th November), and convolving the incubation period, and the survival period.

```{r}
## calculate possible delays from infection to death
child_delay <- as.integer(as.Date("1720-12-18") - as.Date("1720-11-24") + 0:2)
child_delay

## convolve using 1e5 draws from distributions
sim_delay_inf_death <- incub_pneumo$r(1e5) + infec_pneumo$r(1e5)

## calculate p-values
child_delay_pval <- sapply(child_delay, function(x) mean(sim_delay_inf_death >= x))
child_delay_pval
mean(child_delay_pval)

qplot(sim_delay_inf_death) + 
  theme_bw() + 
  geom_vline(xintercept = child_delay, color = 2, linetype = 2) + 
  xlim(0, 40) + 
  labs(
    title = "Simulated delays from infection to death - pneumonic plague",
    subtitle = "dashed lines: JQ -> child transmission",
    x = "Days from infection to death", 
    y = "Frequency"
    )

```

It is very unlikely that the first secondary case was directly infected by Jean Quintin. There remains the possibility that infected surfaces (clothes, bedsheets) were infected by _Y. pestis_, which has been shown to be able to last up to 5 days [@Rose2003-og]. We can replicate the same analysis subtracting these 5 days from the overal delay:

```{r}

qplot(sim_delay_inf_death) + 
  theme_bw() + 
  geom_vline(xintercept = child_delay - 5, color = 2, linetype = 2) + 
  xlim(0, 40) + 
  labs(
    title = "Simulated delays from infection to death - pneumonic plague", 
    subtitle = "dashed lines: JQ -> child transmission",
    x = "Days from infection to death", 
    y = "Frequency"
    )

child_delay_pval_alt <- sapply(child_delay - 5, function(x) mean(sim_delay_inf_death >= x))
child_delay_pval_alt
mean(child_delay_pval_alt)
```

It seems we can rule out the hypothesis of a direct transmission of pneumonic plague. Possible aternatives are:

- it was a bubonic plague, with a long duration of illness in the kid; might be unlikely seeing that patients seem to die very quickly - TBC
- the kid was __not__ infected by his dad, but from a zoonotic source



# Epidemic start

Here we analyse the linelist of the first few cases in Corréjac, followed by La Canourgue.

```{r}
file_path <- here::here("data", "early_linelist.ods")
x <- rio::import(file_path, sheet = "linelist") %>% 
  tibble() %>% 
  mutate(date_of_death = as.Date(date_of_death, format = "%d/%m/%Y"))
x
```

We build a simple epidemic curve for Corréjac:

```{r}
library(incidence2)

x %>% 
  filter(location == "Corréjac") %>% 
  incidence("date_of_death", groups = "family", interval = 7) %>% 
  plot(fill = "family", colour_palette = muted, angle = 45) + 
  labs(
    title = "Early epicurve by date of death - Corréjac",
    x = "Date of death", 
    y = "Number of cases"
    )

i <- x %>% 
  filter(location == "Corréjac") %>% 
  incidence("date_of_death", groups = "family") %>% 
  complete_dates()

```

To estimate the reproduction number, we'll need to account for the fact that we are looking a deaths, and account for the uncertainty in delays from onset to death. This said, as a first approximation we can use _earlyR_ and EpiEstim on the daily epicurve:

```{r}
library(earlyR)
# R_early <- get_R(i$count, si_mean = 8, si_sd = 2)


library(EpiEstim)

```




# References
